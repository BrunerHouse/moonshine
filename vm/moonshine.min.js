 /*
 * Moonshine Lua VM
 * http://moonshinejs.org
 *
 * Copyright 2013 Gamesys Limited.
 * Distributed under the terms of the XXXXXXXXXX license.
 * http://moonshinejs.org/license
 */
 var shine=shine||{};shine.EMPTY_OBJ={};shine.EMPTY_ARR=[];shine.gc={objects:[],arrays:[],collected:0,reused:0,cacheArray:function(a){a.length=0;this.arrays.push(a);this.collected++},cacheObject:function(b){for(var a in b){if(b.hasOwnProperty(a)){delete b[a]}}this.objects.push(b);this.collected++},createArray:function(){if(this.arrays.length){this.reused++}return this.arrays.pop()||[]},createObject:function(){if(this.objects.length){this.reused++}return this.objects.pop()||{}},decrRef:function(a){if(!a||!(a instanceof shine.Table)||a.__shine.refCount===undefined){return}if(--a.__shine.refCount==0){this.collect(a)}},incrRef:function(a){if(!a||!(a instanceof shine.Table)||a.__shine.refCount===undefined){return}a.__shine.refCount++},collect:function(d){if(d===undefined||d===null){return}if(d instanceof Array){return this.cacheArray(d)}if(typeof d=="object"&&d.constructor==Object){return this.cacheObject(d)}if(!(d instanceof shine.Table)||d.__shine.refCount===undefined){return}var b,a,c=d.__shine;for(b=0,a=c.values.length;b<a;b++){this.decrRef(c.values[b])}for(b=0,a=c.numValues.length;b<a;b++){this.decrRef(c.numValues[b])}this.cacheArray(c.keys);this.cacheArray(c.values);delete c.keys;delete c.values;this.cacheObject(c);delete d.__shine;for(b in d){if(d.hasOwnProperty(b)){this.decrRef(d[b])}}}};var shine=shine||{};shine.EventEmitter=function(){this._listeners={}};shine.EventEmitter.prototype._trigger=function(b,f){var d=this._listeners[b],a,c;if(!d){return}if(!((f||shine.EMPTY_OBJ) instanceof Array)){f=[f]}for(c in d){if(d.hasOwnProperty(c)){a=d[c].apply(this,f);if(a!==undefined&&!a){break}}}};shine.EventEmitter.prototype.bind=function(a,b){if(!this._listeners[a]){this._listeners[a]=[]}this._listeners[a].push(b)};shine.EventEmitter.prototype.unbind=function(a,c){for(var b in this._listeners[a]){if(this._listeners[a].hasOwnProperty(b)&&this._listeners[a][b]===c){this._listeners[a].splice(b,1)}}};var shine=shine||{};shine.VM=function(a){shine.EventEmitter.call(this);this._files=[];this._env=a||{};this._coroutineStack=[];this._resetGlobals()};shine.VM.prototype=new shine.EventEmitter();shine.VM.prototype.constructor=shine.VM;shine.VM.prototype._resetGlobals=function(){this._globals=this._bindLib(shine.lib);for(var a in this._globals){if(this._globals.hasOwnProperty(a)&&this._globals[a] instanceof shine.Table){this._globals["package"].loaded[a]=this._globals[a]}}this._globals["package"].loaded._G=this._globals;for(var a in this._env){if(this._env.hasOwnProperty(a)){this._globals[a]=this._env[a]}}};shine.VM.prototype._bindLib=function(c){var a=shine.gc.createObject();for(var b in c){if(c.hasOwnProperty(b)){if(c[b]&&c[b].constructor===Object){a[b]=this._bindLib(c[b])}else{if(typeof c[b]=="function"){a[b]=(function(f,d){return function(){return f.apply(d,arguments)}})(c[b],this)}else{a[b]=c[b]}}}}return new shine.Table(a)};shine.VM.prototype.load=function(b,f,a){var d=this,c;switch(typeof b){case"string":c=new shine.File(b);this._files.push(c);c.bind("loaded",function(g){d._trigger("loaded-file",c);if(f||f===undefined){d.execute(a,c)}});this._trigger("loading-file",c);c.load();break;case"object":c=new shine.File();c.data=b;if(f||f===undefined){d.execute(a,c)}break;default:console.warn("Object of unknown type passed to shine.VM.load()")}};shine.VM.prototype.execute=function(j,b){var h=this,a=b?[b]:this._files,d,b,g;if(!a.length){throw new Error("No files loaded.")}for(d in a){if(a.hasOwnProperty(d)){b=a[d];if(!b.data){throw new Error("Tried to execute file before data loaded.")}g=this._thread=new shine.Function(this,b,b.data,this._globals);this._trigger("executing",[g,j]);try{if(!j){g.call()}else{var i=shine.lib.coroutine.wrap(g),c=function(){i();if(j.uiOnly&&i._coroutine.status!="dead"){window.setTimeout(c,1)}};c()}}catch(f){shine.Error.catchExecutionError(f)}}}};shine.VM.prototype.setGlobal=function(a,b){this._globals[a]=b};shine.VM.prototype.getGlobal=function(a){return this._globals[a]};shine.VM.prototype.dispose=function(){var a;for(var b in this._files){if(this._files.hasOwnProperty(b)){this._files[b].dispose()}}if(a=this._thread){a.dispose()}delete this._files;delete this._thread;delete this._globals;delete this._env;delete this._coroutineStack;shine.Closure._graveyard.splice(0,shine.Closure._graveyard.length);shine.Coroutine._graveyard.splice(0,shine.Coroutine._graveyard.length)};shine.Register=function(){this._items=shine.gc.createArray()};shine.Register._graveyard=[];shine.Register.create=function(){var a=shine.Register._graveyard.pop();return a||new shine.Register(arguments)};shine.Register.prototype.getLength=function(){return this._items.length};shine.Register.prototype.getItem=function(a){return this._items[a]};shine.Register.prototype.setItem=function(a,c){var b=this._items[a];shine.gc.decrRef(b);b=this._items[a]=c;shine.gc.incrRef(b)};shine.Register.prototype.set=function(a){var c,b=Math.max(a.length,this._items.length);for(c=0;c<b;c++){this.setItem(c,a[c])}};shine.Register.prototype.push=function(){this._items.push.apply(this._items,arguments)};shine.Register.prototype.clearItem=function(a){delete this._items[a]};shine.Register.prototype.splice=function(a,b){this._items.splice.apply(this._items,arguments)};shine.Register.prototype.reset=function(){for(var b=0,a=this._items.length;b<a;b++){shine.gc.decrRef(this._items[b])}this._items.length=0};shine.Register.prototype.dispose=function(){this._items.reset();this.constructor._graveyard.push(this)};var shine=shine||{};shine.Closure=function(c,b,g,f,h){var d=this;this._vm=c;this._globals=f;this._file=b;this._data=g;this._upvalues=h||shine.gc.createObject();this._constants=g.constants;this._functions=g.functions;this._instructions=g.instructions;this._register=this._register||shine.Register.create();this._pc=0;this._localsUsedAsUpvalues=this._localsUsedAsUpvalues||shine.gc.createArray();this._funcInstances=this._funcInstances||shine.gc.createArray();var d=this,a=function(){var k=shine.gc.createArray();for(var m=0,j=arguments.length;m<j;m++){k.push(arguments[m])}return d.execute(k)};a._instance=this;a.dispose=function(){d.dispose.apply(d,arguments);delete this.dispose};return a};shine.Closure.prototype={};shine.Closure.prototype.constructor=shine.Closure;shine.Closure._graveyard=[];shine.Closure.create=function(c,b,f,d,g){var a=shine.Closure._graveyard.pop();if(a){return shine.Closure.apply(a,arguments)}else{return new shine.Closure(c,b,f,d,g)}};shine.Closure.prototype.execute=function(c){this._pc=0;this._params=shine.gc.createArray().concat(c);this._register.set(c.splice(0,this._data.paramCount));if(this._data.is_vararg==7){var b=[].concat(c),d=b.length;b=new shine.Table(b);b.setMember("n",d);this._register.push(b)}try{return this._run()}catch(f){if(!((f||shine.EMPTY_OBJ) instanceof shine.Error)){var a=(f.stack||"");f=new shine.Error("Error in host call: "+f.message);f.stack=a;f.luaStack=a.split("\n")}if(!f.luaStack){f.luaStack=shine.gc.createArray()}f.luaStack.push("at "+(this._data.sourceName||"function")+(this._data.linePositions?" on line "+this._data.linePositions[this._pc-1]:""));throw f}};shine.Closure.prototype._run=function(){var d,q,f,n;this.terminated=false;if(shine.debug&&shine.debug.status=="resuming"){if(shine.debug.resumeStack.length){this._pc--}else{shine.debug.status="running"}}else{if(shine.Coroutine._running&&shine.Coroutine._running.status=="resuming"){if(shine.Coroutine._running._resumeStack.length){this._pc--}else{shine.Coroutine._running.status="running";n=shine.Coroutine._running._yieldVars}}}if(n){var h=(this._pc-1)*4,p=this._instructions[h+1],o=this._instructions[h+2],m=this._instructions[h+3],k=shine.gc.createArray();for(var j=0,g=n.length;j<g;j++){k.push(n[j])}if(m===0){g=k.length;for(j=0;j<g;j++){this._register.setItem(p+j,k[j])}this._register.splice(p+g)}else{for(j=0;j<m-1;j++){this._register.setItem(p+j,k[j])}}shine.gc.collect(k)}while(this._instructions[this._pc*4]!==undefined){q=this._data.linePositions&&this._data.linePositions[this._pc];f=this._executeInstruction(this._pc++,q);if(shine.Coroutine._running&&shine.Coroutine._running.status=="suspending"){shine.Coroutine._running._resumeStack.push(this);if(shine.Coroutine._running._func._instance==this){f=shine.Coroutine._running._yieldVars;shine.Coroutine._running.status="suspended";shine.Coroutine._remove();return f}return}if(shine.debug&&shine.debug.status=="suspending"&&!f){shine.debug.resumeStack.push(this);return f}if(f!==undefined){this.terminated=true;this.dispose();return f}}this.terminated=true;this.dispose()};shine.Closure.prototype._executeInstruction=function(c,b){var g=c*4,d=this._instructions[g],i=this.constructor.OPERATIONS[d],a=this._instructions[g+1],h=this._instructions[g+2],f=this._instructions[g+3];if(!i){throw new Error("Operation not implemented! ("+d+")")}return i.call(this,a,h,f)};shine.Closure.prototype._getConstant=function(a){if(this._constants[a]===null){return}return this._constants[a]};shine.Closure.prototype.hasRetainedScope=function(){if(this._localsUsedAsUpvalues.length){return true}if(this._upvalues.length){return true}for(var a in this._funcInstances){if(this._funcInstances.hasOwnProperty(a)&&this._funcInstances[a].isRetained()){return true}}return false};shine.Closure.prototype.dispose=function(a){if(a||!this.hasRetainedScope()){delete this._vm;delete this._globals;delete this._file;delete this._data;delete this._functions;delete this._instructions;delete this._pc;shine.gc.collect(this._params);delete this._params;delete this._constants;shine.gc.collect(this._upvalues);delete this._upvalues;this._register.reset();this._funcInstances.length=0;this._localsUsedAsUpvalues.length=0;shine.Closure._graveyard.push(this)}};(function(){function n(O,N){this._register.setItem(O,this._register.getItem(N))}function b(N,O){this._register.setItem(N,this._getConstant(O))}function r(O,N,P){this._register.setItem(O,!!N);if(P){this._pc++}}function J(O,N){for(var P=O;P<=N;P++){this._register.setItem(P,undefined)}}function C(O,N){if(this._upvalues[N]===undefined){return}this._register.setItem(O,this._upvalues[N].getValue())}function j(O,N){if(this._getConstant(N)=="_G"){this._register.setItem(O,new shine.Table(this._globals))}else{if(this._globals[this._getConstant(N)]!==undefined){this._register.setItem(O,this._globals[this._getConstant(N)])}else{this._register.setItem(O,undefined)}}}function y(O,N,P){P=(P>=256)?this._getConstant(P-256):this._register.getItem(P);if(this._register.getItem(N)===undefined){throw new shine.Error("Attempt to index a nil value ("+P+" not present in nil)")}else{if((this._register.getItem(N)||shine.EMPTY_OBJ) instanceof shine.Table){this._register.setItem(O,this._register.getItem(N).getMember(P))}else{if(typeof this._register.getItem(N)=="string"&&shine.lib.string[P]){this._register.setItem(O,shine.lib.string[P])}else{this._register.setItem(O,this._register.getItem(N)[P])}}}}function m(O,N){var R=this._getConstant(N),P=this._globals[R],Q=this._register.getItem(O);this._globals[R]=Q;shine.gc.decrRef(P);shine.gc.incrRef(Q)}function A(O,N){this._upvalues[N].setValue(this._register.getItem(O))}function w(O,N,P){N=(N>=256)?this._getConstant(N-256):this._register.getItem(N);P=(P>=256)?this._getConstant(P-256):this._register.getItem(P);if((this._register.getItem(O)||shine.EMPTY_OBJ) instanceof shine.Table){this._register.getItem(O).setMember(N,P)}else{if(this._register.getItem(O)===undefined){throw new shine.Error("Attempt to index a missing field (can't set \""+N+'" on a nil value)')}else{this._register.getItem(O)[N]=P}}}function E(O,N,Q){var P=new shine.Table();P.__shine.refCount=0;this._register.setItem(O,P)}function l(O,N,P){P=(P>=256)?this._getConstant(P-256):this._register.getItem(P);this._register.setItem(O+1,this._register.getItem(N));if(this._register.getItem(N)===undefined){throw new shine.Error("Attempt to index a nil value ("+P+" not present in nil)")}else{if((this._register.getItem(N)||shine.EMPTY_OBJ) instanceof shine.Table){this._register.setItem(O,this._register.getItem(N).getMember(P))}else{if(typeof this._register.getItem(N)=="string"&&shine.lib.string[P]){this._register.setItem(O,shine.lib.string[P])}else{this._register.setItem(O,this._register.getItem(N)[P])}}}}function h(O,N,U){N=(N>=256)?this._getConstant(N-256):this._register.getItem(N);U=(U>=256)?this._getConstant(U-256):this._register.getItem(U);var Q=shine.utils.coerce,P,R,S,T;if(((N||shine.EMPTY_OBJ) instanceof shine.Table&&(P=N.__shine.metatable)&&(R=P.getMember("__add")))||((U||shine.EMPTY_OBJ) instanceof shine.Table&&(P=U.__shine.metatable)&&(R=P.getMember("__add")))){this._register.setItem(O,R.apply(null,[N,U],true)[0])}else{N=Q(N,"number","attempt to perform arithmetic on a non-numeric value");U=Q(U,"number","attempt to perform arithmetic on a non-numeric value");this._register.setItem(O,N+U)}}function s(O,N,S){N=(N>=256)?this._getConstant(N-256):this._register.getItem(N);S=(S>=256)?this._getConstant(S-256):this._register.getItem(S);var Q=shine.utils.coerce,P,R;if(((N||shine.EMPTY_OBJ) instanceof shine.Table&&(P=N.__shine.metatable)&&(R=P.getMember("__sub")))||((S||shine.EMPTY_OBJ) instanceof shine.Table&&(P=S.__shine.metatable)&&(R=P.getMember("__sub")))){this._register.setItem(O,R.apply(null,[N,S],true)[0])}else{N=Q(N,"number","attempt to perform arithmetic on a non-numeric value");S=Q(S,"number","attempt to perform arithmetic on a non-numeric value");this._register.setItem(O,N-S)}}function d(O,N,S){N=(N>=256)?this._getConstant(N-256):this._register.getItem(N);S=(S>=256)?this._getConstant(S-256):this._register.getItem(S);var Q=shine.utils.coerce,P,R;if(((N||shine.EMPTY_OBJ) instanceof shine.Table&&(P=N.__shine.metatable)&&(R=P.getMember("__mul")))||((S||shine.EMPTY_OBJ) instanceof shine.Table&&(P=S.__shine.metatable)&&(R=P.getMember("__mul")))){this._register.setItem(O,R.apply(null,[N,S],true)[0])}else{N=Q(N,"number","attempt to perform arithmetic on a non-numeric value");S=Q(S,"number","attempt to perform arithmetic on a non-numeric value");this._register.setItem(O,N*S)}}function I(O,N,S){N=(N>=256)?this._getConstant(N-256):this._register.getItem(N);S=(S>=256)?this._getConstant(S-256):this._register.getItem(S);var Q=shine.utils.coerce,P,R;if(((N||shine.EMPTY_OBJ) instanceof shine.Table&&(P=N.__shine.metatable)&&(R=P.getMember("__div")))||((S||shine.EMPTY_OBJ) instanceof shine.Table&&(P=S.__shine.metatable)&&(R=P.getMember("__div")))){this._register.setItem(O,R.apply(null,[N,S],true)[0])}else{N=Q(N,"number","attempt to perform arithmetic on a non-numeric value");S=Q(S,"number","attempt to perform arithmetic on a non-numeric value");this._register.setItem(O,N/S)}}function i(P,O,U){O=(O>=256)?this._getConstant(O-256):this._register.getItem(O);U=(U>=256)?this._getConstant(U-256):this._register.getItem(U);var R=shine.utils.coerce,Q,T,N,S;if(((O||shine.EMPTY_OBJ) instanceof shine.Table&&(Q=O.__shine.metatable)&&(T=Q.getMember("__mod")))||((U||shine.EMPTY_OBJ) instanceof shine.Table&&(Q=U.__shine.metatable)&&(T=Q.getMember("__mod")))){this._register.setItem(P,T.apply(null,[O,U],true)[0])}else{O=R(O,"number","attempt to perform arithmetic on a non-numeric value");U=R(U,"number","attempt to perform arithmetic on a non-numeric value");if(U===0||U===-Infinity||U===Infinity||window.isNaN(O)||window.isNaN(U)){N=NaN}else{N=Math.abs(O)%(S=Math.abs(U));if(O*U<0){N=S-N}if(U<0){N*=-1}}this._register.setItem(P,N)}}function x(O,N,S){N=(N>=256)?this._getConstant(N-256):this._register.getItem(N);S=(S>=256)?this._getConstant(S-256):this._register.getItem(S);var Q=shine.utils.coerce,P,R;if(((N||shine.EMPTY_OBJ) instanceof shine.Table&&(P=N.__shine.metatable)&&(R=P.getMember("__pow")))||((S||shine.EMPTY_OBJ) instanceof shine.Table&&(P=S.__shine.metatable)&&(R=P.getMember("__pow")))){this._register.setItem(O,R.apply(null,[N,S],true)[0])}else{N=Q(N,"number","attempt to perform arithmetic on a non-numeric value");S=Q(S,"number","attempt to perform arithmetic on a non-numeric value");this._register.setItem(O,Math.pow(N,S))}}function p(O,N){var P,Q;if((this._register.getItem(N)||shine.EMPTY_OBJ) instanceof shine.Table&&(P=this._register.getItem(N).__shine.metatable)&&(Q=P.getMember("__unm"))){this._register.setItem(O,Q.apply(null,[this._register.getItem(N)],true)[0])}else{N=shine.utils.coerce(this._register.getItem(N),"number","attempt to perform arithmetic on a non-numeric value");this._register.setItem(O,-N)}}function G(O,N){this._register.setItem(O,!this._register.getItem(N))}function o(O,N){var Q=0;if((this._register.getItem(N)||shine.EMPTY_OBJ) instanceof shine.Table){this._register.setItem(O,shine.lib.table.getn(this._register.getItem(N)))}else{if(typeof this._register.getItem(N)=="object"){for(var P in this._register.getItem(N)){if(this._register.getItem(N).hasOwnProperty(P)){Q++}}this._register.setItem(O,Q)}else{if(this._register.getItem(N)==undefined){throw new shine.Error("attempt to get length of a nil value")}else{if(this._register.getItem(N).length===undefined){this._register.setItem(O,undefined)}else{this._register.setItem(O,this._register.getItem(N).length)}}}}}function v(O,N,T){var S=this._register.getItem(T),P,R;for(var Q=T-1;Q>=N;Q--){if(((this._register.getItem(Q)||shine.EMPTY_OBJ) instanceof shine.Table&&(P=this._register.getItem(Q).__shine.metatable)&&(R=P.getMember("__concat")))||((S||shine.EMPTY_OBJ) instanceof shine.Table&&(P=S.__shine.metatable)&&(R=P.getMember("__concat")))){S=R.apply(null,[this._register.getItem(Q),S],true)[0]}else{if(!(typeof this._register.getItem(Q)==="string"||typeof this._register.getItem(Q)==="number")||!(typeof S==="string"||typeof S==="number")){throw new shine.Error("Attempt to concatenate a non-string or non-numeric value")}S=this._register.getItem(Q)+S}}this._register.setItem(O,S)}function K(O,N){this._pc+=N}function H(P,O,T){O=(O>=256)?this._getConstant(O-256):this._register.getItem(O);T=(T>=256)?this._getConstant(T-256):this._register.getItem(T);var R,Q,S,N;if(O!==T&&(O||shine.EMPTY_OBJ) instanceof shine.Table&&(T||shine.EMPTY_OBJ) instanceof shine.Table&&(R=O.__shine.metatable)&&(Q=T.__shine.metatable)&&R===Q&&(S=R.getMember("__eq"))){N=!!S.apply(null,[O,T],true)[0]}else{N=(O===T)}if(N!=P){this._pc++}}function u(U,T,R){T=(T>=256)?this._getConstant(T-256):this._register.getItem(T);R=(R>=256)?this._getConstant(R-256):this._register.getItem(R);var S=(typeof T!="object"&&typeof T)||((T||shine.EMPTY_OBJ) instanceof shine.Table&&"table")||"userdata",Q=(typeof R!="object"&&typeof T)||((R||shine.EMPTY_OBJ) instanceof shine.Table&&"table")||"userdata",P,V,O,N;if(S!==Q){throw new shine.Error("attempt to compare "+S+" with "+Q)}else{if(S=="table"){if((O=T.__shine.metatable)&&(N=R.__shine.metatable)&&O===N&&(P=O.getMember("__lt"))){V=P.apply(null,[T,R],true)[0]}else{throw new shine.Error("attempt to compare two table values")}}else{V=(T<R)}}if(V!=U){this._pc++}}function D(U,T,R){T=(T>=256)?this._getConstant(T-256):this._register.getItem(T);R=(R>=256)?this._getConstant(R-256):this._register.getItem(R);var S=(typeof T!="object"&&typeof T)||((T||shine.EMPTY_OBJ) instanceof shine.Table&&"table")||"userdata",Q=(typeof R!="object"&&typeof T)||((R||shine.EMPTY_OBJ) instanceof shine.Table&&"table")||"userdata",P,V,O,N;if(S!==Q){throw new shine.Error("attempt to compare "+S+" with "+Q)}else{if(S=="table"){if((O=T.__shine.metatable)&&(N=R.__shine.metatable)&&O===N&&(P=O.getMember("__le"))){V=P.apply(null,[T,R],true)[0]}else{throw new shine.Error("attempt to compare two table values")}}else{V=(T<=R)}}if(V!=U){this._pc++}}function k(O,N,P){if(this._register.getItem(O)===0||this._register.getItem(O)===""){if(!P){this._pc++}}else{if(!this._register.getItem(O)!==!P){this._pc++}}}function f(O,N,P){if(!this._register.getItem(N)!==!P){this._register.setItem(O,this._register.getItem(N))}else{this._pc++}}function c(X,W,V){var U=shine.gc.createArray(),R,P,S,Q,T,O,N;if(shine.debug&&shine.debug.status=="resuming"){Q=shine.debug.resumeStack.pop();if((Q||shine.EMPTY_OBJ) instanceof shine.Coroutine){S=Q.resume()}else{S=Q._run()}}else{if(shine.Coroutine._running&&shine.Coroutine._running.status=="resuming"){Q=shine.Coroutine._running._resumeStack.pop();S=Q._run()}else{if(W===0){P=this._register.getLength();for(R=X+1;R<P;R++){U.push(this._register.getItem(R))}}else{for(R=0;R<W-1;R++){U.push(this._register.getItem(X+R+1))}}}}if(!Q){O=this._register.getItem(X);if((O||shine.EMPTY_OBJ) instanceof shine.Function){S=O.apply(null,U,true)}else{if(O&&O.apply){S=O.apply(null,U)}else{if(O&&(O||shine.EMPTY_OBJ) instanceof shine.Table&&(N=O.__shine.metatable)&&(T=N.getMember("__call"))&&T.apply){U.unshift(O);S=T.apply(null,U,true)}else{throw new shine.Error("Attempt to call non-function")}}}}shine.gc.collect(U);if(!((S||shine.EMPTY_OBJ) instanceof Array)){S=[S]}if(shine.Coroutine._running&&shine.Coroutine._running.status=="suspending"){return}if(V===0){P=S.length;for(R=0;R<P;R++){this._register.setItem(X+R,S[R])}this._register.splice(X+P)}else{for(R=0;R<V-1;R++){this._register.setItem(X+R,S[R])}}}function M(O,N){return c.call(this,O,N,0)}function z(P,N){var Q=shine.gc.createArray(),S,R,O;if(N===0){O=this._register.getLength();for(R=P;R<O;R++){Q.push(this._register.getItem(R))}}else{for(R=0;R<N-1;R++){Q.push(S=this._register.getItem(P+R));shine.gc.incrRef(S)}}F.call(this,0);this.dead=true;return Q}function q(O,N){this._register.setItem(O,this._register.getItem(O)+this._register.getItem(O+2));var P=this._register.getItem(O+2)/Math.abs(this._register.getItem(O+2));if((P===1&&this._register.getItem(O)<=this._register.getItem(O+1))||(P!==1&&this._register.getItem(O)>=this._register.getItem(O+1))){this._register.setItem(O+3,this._register.getItem(O));this._pc+=N}}function L(O,N){this._register.setItem(O,this._register.getItem(O)-this._register.getItem(O+2));this._pc+=N}function t(O,N,T){var R=[this._register.getItem(O+1),this._register.getItem(O+2)],P=this._register.getItem(O).apply(null,R),Q;if(!((P||shine.EMPTY_OBJ) instanceof Array)){P=[P]}if(P[0]&&P[0]===""+(Q=parseInt(P[0],10))){P[0]=Q}for(var S=0;S<T;S++){this._register.setItem(O+S+3,P[S])}if(this._register.getItem(O+3)!==undefined){this._register.setItem(O+2,this._register.getItem(O+3))}else{this._pc++}}function g(O,N,R){var Q=N||this._register.getLength()-O-1,P;for(P=0;P<Q;P++){this._register.getItem(O).setMember(50*(R-1)+P+1,this._register.getItem(O+P+1))}}function F(P,N,S){for(var R=0,O=this._localsUsedAsUpvalues.length;R<O;R++){var Q=this._localsUsedAsUpvalues[R];if(Q&&Q.registerIndex>=P){Q.upvalue.value=this._register.getItem(Q.registerIndex);Q.upvalue.open=false;this._localsUsedAsUpvalues.splice(R--,1);O--;this._register.clearItem(Q.registerIndex)}}}function a(N,R){var P=this,S=shine.gc.createArray(),Q;while((Q=this._instructions[this._pc*4])!==undefined&&(Q===0||Q===4)&&this._instructions[this._pc*4+1]===0){(function(){var aa=Q,X=P._pc*4,V=P._instructions[X+1],U=P._instructions[X+2],T=P._instructions[X+3],ab;if(aa===0){for(var Y=0,W=P._localsUsedAsUpvalues.length;Y<W;Y++){var Z=P._localsUsedAsUpvalues[Y];if(Z.registerIndex===U){ab=Z.upvalue;break}}if(!ab){ab={open:true,getValue:function(){return this.open?P._register.getItem(U):this.value},setValue:function(ac){this.open?P._register.setItem(U,ac):this.value=ac},name:P._functions[R].upvalues[S.length]};P._localsUsedAsUpvalues.push({registerIndex:U,upvalue:ab})}S.push(ab)}else{S.push({getValue:function(){return P._upvalues[U].getValue()},setValue:function(ac){P._upvalues[U].setValue(ac)},name:P._upvalues[U].name})}})();this._pc++}var O=new shine.Function(this._vm,this._file,this._functions[R],this._globals,S);this._register.setItem(N,O)}function B(Q,N){var R,P,O=N===0?this._params.length-this._data.paramCount:N-1;for(R=0;R<O;R++){this._register.setItem(Q+R,this._params[this._data.paramCount+R])}for(R=Q+O,P=this._register.getLength();R<P;R++){this._register.clearItem(R)}}shine.Closure.OPERATIONS=[n,b,r,J,C,j,y,m,A,w,E,l,h,s,d,I,i,x,p,G,o,v,K,H,u,D,k,f,c,M,z,q,L,t,g,F,a,B];shine.Closure.OPERATION_NAMES=["move","loadk","loadbool","loadnil","getupval","getglobal","gettable","setglobal","setupval","settable","newtable","self","add","sub","mul","div","mod","pow","unm","not","len","concat","jmp","eq","lt","le","test","testset","call","tailcall","return","forloop","forprep","tforloop","setlist","close","closure","vararg"]})();var shine=shine||{};shine.Function=function(b,a,d,c,f){this._vm=b;this._file=a;this._data=d;this._globals=c;this._upvalues=f||shine.gc.createObject();this._index=shine.Function._index++;this.instances=shine.gc.createArray();this._retainCount=0;this._convertInstructions()};shine.Function.prototype={};shine.Function.prototype.constructor=shine.Function;shine.Function._index=0;shine.Function.prototype.getInstance=function(){return shine.Closure.create(this._vm,this._file,this._data,this._globals,this._upvalues)};shine.Function.prototype._convertInstructions=function(){var c=this._data.instructions,f,b,g,d,a,h;if("ArrayBuffer" in window){if(c instanceof Int32Array){return}f=new ArrayBuffer(c.length*4*4);b=new Int32Array(f);if(c.length==0||c[0].op===undefined){b.set(c);this._data.instructions=b;return}}else{if(c.length==0||c[0].op===undefined){return}b=[]}for(g=0,d=c.length;g<d;g++){a=c[g];h=g*4;b[h]=a.op;b[h+1]=a.A;b[h+2]=a.B;b[h+3]=a.C}this._data.instructions=b};shine.Function.prototype.call=function(){var b=shine.gc.createArray(),a=arguments.length,c;for(c=1;c<a;c++){b.push(arguments[c])}return this.apply(b)};shine.Function.prototype.apply=function(f,b,a){if((f||shine.EMPTY_OBJ) instanceof Array&&!b){b=f;f=undefined}var c=a?this.getInstance():shine.lib.coroutine.wrap(this);try{return c.apply(f,b)}catch(d){shine.Error.catchExecutionError(d)}};shine.Function.prototype.toString=function(){return"function: 0x"+this._index.toString(16)};shine.Function.prototype.retain=function(){this._retainCount++};shine.Function.prototype.release=function(){if(!--this._retainCount&&this._readyToDispose){this.dispose()}};shine.Function.prototype.isRetained=function(){if(this._retainCount){return true}for(var a in this.instances){if(this.instances.hasOwnProperty(a)&&this.instances[a].hasRetainedScope()){return true}}return false};shine.Function.prototype.dispose=function(c){this._readyToDispose=true;if(c){for(var b=0,a=this.instances.length;b<a;b++){this.instances[b].dispose(true)}}else{if(this.isRetained()){return false}}delete this._vm;delete this._file;delete this._data;delete this._globals;delete this._upvalues;delete this.instances;delete this._readyToDispose;return true};var shine=shine||{};shine.Coroutine=function(a){shine.EventEmitter.call(this);this._func=a.getInstance();this._index=shine.Coroutine._index++;this._started=false;this._yieldVars=undefined;this._resumeStack=this._resumeStack||shine.gc.createArray();this.status="suspended";shine.stddebug.write("[coroutine created]\n")};shine.Coroutine.prototype=new shine.EventEmitter();shine.Coroutine.prototype.constructor=shine.Function;shine.Coroutine._index=0;shine.Coroutine._stack=[];shine.Coroutine._graveyard=[];shine.Coroutine.create=function(b){var a=shine.Coroutine._graveyard.pop();if(a){shine.Coroutine.apply(a,arguments);return a}else{return new shine.Coroutine(b)}};shine.Coroutine._add=function(a){shine.Coroutine._stack.push(shine.Coroutine._running);shine.Coroutine._running=a};shine.Coroutine._remove=function(){shine.Coroutine._running=shine.Coroutine._stack.pop()};shine.Coroutine.prototype.resume=function(){var b;try{if(this.status=="dead"){throw new shine.Error("cannot resume dead coroutine")}shine.Coroutine._add(this);if(shine.debug&&shine.debug.status=="resuming"){var g=shine.debug.resumeStack.pop();if((g||shine.EMPTY_OBJ) instanceof shine.Coroutine){b=g.resume()}else{b=this._func._instance._run()}}else{if(!this._started){this.status="running";shine.stddebug.write("[coroutine started]\n");this._started=true;b=this._func.apply(null,arguments,true)}else{this.status="resuming";shine.stddebug.write("[coroutine resuming]\n");var c=shine.gc.createArray();for(var d=0,a=arguments.length;d<a;d++){c.push(arguments[d])}this._yieldVars=c;b=this._resumeStack.pop()._run()}}if(shine.debug&&shine.debug.status=="suspending"){shine.debug.resumeStack.push(this);return}this.status=this._func._instance.terminated?"dead":"suspended";if(b){b.unshift(true)}}catch(f){b=[false,f];this.status="dead"}if(this.status=="dead"){shine.Coroutine._remove();shine.stddebug.write("[coroutine terminated]\n");this._dispose()}return b};shine.Coroutine.prototype.toString=function(){return"thread: 0x"+this._index.toString(16)};shine.Coroutine.prototype._dispose=function(){delete this._func;delete this._index;delete this._listeners;delete this._started;delete this._yieldVars;delete this.status;this._resumeStack.length=0;shine.Coroutine._graveyard.push(this)};var shine=shine||{};shine.Table=function(h){var d=((h||shine.EMPTY_OBJ) instanceof Array),g,c,f,b;h=h||shine.gc.createObject();this.__shine=g=shine.gc.createObject();g.type="table";g.index=++shine.Table.count;g.keys=shine.gc.createArray();g.values=shine.gc.createArray();g.numValues=[undefined];for(b in h){if(h.hasOwnProperty(b)){var a;c=d?parseInt(b,10)+1:b;f=h[b];if(typeof getQualifiedClassName!=="undefined"){a=((getQualifiedClassName(f)=="Object")&&(!(f instanceof shine.Table))&&(!(f instanceof shine.Coroutine))&&(!(f instanceof shine.Function))&&(!(f instanceof shine.Closure)))||(getQualifiedClassName(f)=="Array")}else{a=(typeof f=="object"&&f.constructor===Object)||f instanceof Array}this.setMember(c,a?new shine.Table(f):f)}}};shine.Table.count=0;shine.Table.prototype.getMember=function(c){var b,d;switch(typeof c){case"string":if(this[c]!==undefined){return this[c]}break;case"number":d=this.__shine.numValues[c];if(d!==undefined){return d}default:b=this.__shine.keys.indexOf(c);if(b>=0){return this.__shine.values[b]}}var a=this.__shine.metatable;if(a&&a.__index){switch(a.__index.constructor){case shine.Table:return a.__index.getMember(c);case Function:return a.__index(this,c);case shine.Function:return a.__index.apply(this,[this,c])[0]}}};shine.Table.prototype.setMember=function(d,g){var a=this.__shine.metatable,c,f,b;if(this[d]===undefined&&a&&a.__newindex){switch(a.__newindex.constructor){case shine.Table:return a.__newindex.setMember(d,g);case Function:return a.__newindex(this,d,g);case shine.Function:return a.__newindex.apply(this,[this,d,g])[0]}}switch(typeof d){case"string":c=this[d];this[d]=g;break;case"number":c=this.__shine.numValues[d];this.__shine.numValues[d]=g;break;default:f=this.__shine.keys;b=f.indexOf(d);if(b<0){b=f.length;f[b]=d}c=this.__shine.values[b];this.__shine.values[b]=g}shine.gc.decrRef(c);shine.gc.incrRef(g)};shine.Table.prototype.toString=function(){var a;if(this.constructor!=shine.Table){return"userdata"}if(this.__shine&&(a=this.__shine.metatable)&&a.__tostring){return a.__tostring.call(undefined,this)}return"table: 0x"+this.__shine.index.toString(16)};var shine=shine||{};shine.Error=function(b){var a=new Error(b);a.constructor=this.constructor;a.__proto__=this;a.name="shine.Error";return a};shine.Error.prototype=new Error();shine.Error.prototype.constructor=shine.Error;shine.Error.catchExecutionError=function(a){if(!a){return}if((a||shine.EMPTY_OBJ) instanceof shine.Error){if(!a.luaMessage){a.luaMessage=a.message}a.message=a.luaMessage+"\n    "+(a.luaStack||shine.gc.createArray()).join("\n    ")}throw a};shine.Error.prototype.toString=function(){return"Moonshine Error: "+this.message};var shine=shine||{};shine.File=function(a){shine.EventEmitter.call(this);this._url=a;this.data=undefined};shine.File.prototype=new shine.EventEmitter();shine.File.prototype.constructor=shine.File;shine.File.prototype.load=function(){var b=this;function c(d){b.data=JSON.parse(d);b._trigger("loaded",b.data)}function a(d){b._trigger("error",d)}shine.utils.get(this._url,c,a)};shine.File.prototype.loadLua=function(){};shine.File.prototype.dispose=function(){delete this._url;delete this.data};var shine=shine||{};(function(){var b=16807,f=2147483647,d={"([^a-zA-Z0-9%(])-":"$1*?","(.)-([^a-zA-Z0-9?])":"$1*?$2","(.)-$":"$1*?","%a":"[a-zA-Z]","%A":"[^a-zA-Z]","%c":"[\x00-\x1f]","%C":"[^\x00-\x1f]","%d":"\\d","%D":"[^\d]","%l":"[a-z]","%L":"[^a-z]","%p":"[.,\"'?!;:#$%&()*+-/<>=@[]\\^_{}|~]","%P":"[^.,\"'?!;:#$%&()*+-/<>=@[]\\^_{}|~]","%s":"[ \\t\\n\\f\\v\\r]","%S":"[^ \t\n\f\v\r]","%u":"[A-Z]","%U":"[^A-Z]","%w":"[a-zA-Z0-9]","%W":"[^a-zA-Z0-9]","%x":"[a-fA-F0-9]","%X":"[^a-fA-F0-9]","%([^a-zA-Z])":"\\$1"},g=1;function c(){g=(b*g)%f;return g/f}function h(p){p=""+p;var q=0,m,j,o,k;for(m in d){if(d.hasOwnProperty(m)){p=p.replace(new RegExp(m,"g"),d[m])}}j=p.length;for(m=0;m<j;m++){o=p.substr(m,1);k=false;if(o=="["){if(q){k=true}q++}else{if(o=="]"){q--;if(q){k=true}}}if(k){p=p.substr(0,m)+"\\"+p.substr(m++);j++}}return p}function a(i,m){var k=this,j,l;if(i.substr(0,1)!="/"){l=(this._thread._file._url||"").match(/^(.*\/).*?$/);l=(l&&l[1])||"";i=l+i}j=new shine.File(i);j.bind("loaded",function(o){var n=new shine.Function(k,j,j.data,k._globals);k._trigger("module-loaded",j,n);m(n)});j.bind("error",function(n){k._trigger("module-load-error",j,n);m()});this._trigger("loading-module",j);j.load()}shine.lib={assert:function(j,i){if(j===false||j===undefined){throw new shine.Error(i||"Assertion failed!")}return[j,i]},collectgarbage:function(j,i){},dofile:function(i){},error:function(i){throw new shine.Error(i)},getfenv:function(i){},getmetatable:function(i){if(!((i||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in getmetatable(). Table expected")}return i.__shine.metatable},ipairs:function(j){if(!((j||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in ipairs(). Table expected")}var i=function(m,l){if(l===undefined){throw new shine.Error("Bad argument #2 to ipairs() iterator")}var k=l+1;if(!m.__shine.numValues.hasOwnProperty(k)){return undefined}return[k,m.__shine.numValues[k]]};return[i,j,0]},load:function(n,j){var l=new shine.File,k="",m,i;while((m=n())&&m!=i){k+=(i=m)}l._data=JSON.parse(k);return new shine.Function(this,l,l._data,this._globals,shine.gc.createArray())},loadfile:function(j){var i=shine.lib.coroutine.yield(),k=function(l){i.resume(l)};a.call(this,j,k)},loadstring:function(j,i){var k=function(){return j};return shine.lib.load.call(this,k,i)},next:function(p,m){var q=(m===undefined),k=p.__shine.numValues,o,j;if(q||typeof m=="number"){for(o=1,j=k.length;o<j;o++){if(!q){if(o===m){q=true}}else{if(k.hasOwnProperty(o)&&k[o]!==undefined){return[o,k[o]]}}}}for(o in p){if(p.hasOwnProperty(o)&&!(o in shine.Table.prototype)&&o!=="__shine"){if(!q){if(o==m){q=true}}else{if(p.hasOwnProperty(o)&&p[o]!==undefined&&(""+o).substr(0,2)!="__"){return[o,p[o]]}}}}for(o in p.__shine.keys){if(p.__shine.keys.hasOwnProperty(o)){var n=p.__shine.keys[o];if(!q){if(n===m){q=true}}else{if(p.__shine.values[o]!==undefined){return[n,p.__shine.values[o]]}}}}return shine.gc.createArray()},pairs:function(i){if(!((i||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in pairs(). Table expected")}return[shine.lib.next,i]},pcall:function(o){var m=shine.gc.createArray(),j;for(var n=1,k=arguments.length;n<k;n++){m.push(arguments[n])}try{if(typeof o=="function"){j=o.apply(null,m)}else{if((o||shine.EMPTY_OBJ) instanceof shine.Function){j=o.apply(null,m,true)}else{throw new shine.Error("Attempt to call non-function")}}}catch(p){return[false,p.message]}if(!((j||shine.EMPTY_OBJ) instanceof Array)){j=[j]}j.unshift(true);return j},print:function(){var k=shine.gc.createArray(),n;for(var m=0,j=arguments.length;m<j;m++){n=arguments[m];if((n||shine.EMPTY_OBJ) instanceof shine.Table){k.push("table: 0x"+n.__shine.index.toString(16))}else{if((n||shine.EMPTY_OBJ) instanceof Function){k.push("JavaScript function: "+n.toString())}else{if(n===undefined){k.push("nil")}else{k.push(shine.lib.tostring(n))}}}}return shine.stdout.write(k.join("\t"))},rawequal:function(j,i){return(j===i)},rawget:function(j,i){if(!((j||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in rawget(). Table expected")}return j[i]},rawset:function(j,i,k){if(!((j||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in rawset(). Table expected")}if(i==undefined){throw new shine.Error("Bad argument #2 in rawset(). Nil not allowed")}j[i]=k;return j},require:function(k){var n,l=shine.lib["package"],j=this,i,o,q,r;function p(s){l.loaded[k]=true;i=s.call(null,k)[0];if(i!==undefined){l.loaded[k]=i}return l.loaded[k]}if(i=l.loaded[k]){return i}if(o=l.preload[k]){return p(o)}q=l.path.replace(/;;/g,";").split(";");n=shine.lib.coroutine.yield();function m(){r=q.shift();if(!r){n.resume()}else{r=r.replace(/\?/g,k);a.call(j,r,function(s){if(s){n.resume(p(s))}else{m()}})}}m()},select:function(m){var k=shine.gc.createArray();if(m=="#"){return arguments.length-1}else{if(m=parseInt(m,10)){for(var n=m,j=arguments.length;n<j;n++){k.push(arguments[n])}return k}else{throw new shine.Error('Bad argument #1 in select(). Number or "#" expected')}}},setmetatable:function(j,i){if(!((j||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in setmetatable(). Table expected")}if(!(i===undefined||(i||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #2 in setmetatable(). Nil or table expected")}shine.gc.decrRef(j.__shine.metatable);j.__shine.metatable=i;shine.gc.incrRef(i);return j},tonumber:function(j,i){if(j===""){return}j=(""+j).replace(/^\s+|\s+$/g,"");i=i||10;if(i===2&&j.match(/[^01]/)){return}if(i===10&&j.match(/[^0-9e\+\-\.]/)){return}if(i===16&&j.match(/[^0-9A-Fa-f]/)){return}return(i==10)?parseFloat(j):parseInt(j,i)},tostring:function(i){switch(true){case i===undefined:return"nil";case i===Infinity:return"inf";case i===-Infinity:return"-inf";case typeof i=="number"&&window.isNaN(i):return"nan";default:return i.toString()}},type:function(i){var j=typeof(i);switch(j){case"undefined":return"nil";case"number":case"string":case"boolean":case"function":return j;case"object":if(i.constructor===shine.Table){return"table"}if((i||shine.EMPTY_OBJ) instanceof shine.Function){return"function"}return"userdata"}},unpack:function(m,l,k){return shine.lib.table.unpack(m,l,k)},_VERSION:"Lua 5.1",xpcall:function(k,j){var i,n,l;try{if(typeof k=="function"){i=k.apply()}else{if((k||shine.EMPTY_OBJ) instanceof shine.Function){i=k.apply(null,undefined,true)}else{l=true}}n=true}catch(m){i=j.apply(null,undefined,true);if(((i||shine.EMPTY_OBJ) instanceof Array)){i=i[0]}n=false}if(l){throw new shine.Error("Attempt to call non-function")}if(!((i||shine.EMPTY_OBJ) instanceof Array)){i=[i]}i.unshift(n);return i}};shine.lib.coroutine={create:function(i){return shine.Coroutine.create(i)},resume:function(j){var m=shine.gc.createArray();for(var n=1,k=arguments.length;n<k;n++){m.push(arguments[n])}return j.resume.apply(j,m)},running:function(){return shine.Coroutine._running},status:function(i){return i.status},wrap:function(k){var j=shine.lib.coroutine.create(k);var i=function(){var o=[j];for(var p=0,m=arguments.length;p<m;p++){o.push(arguments[p])}var n=shine.lib.coroutine.resume.apply(null,o),q=n.shift();if(q){return n}throw n[0]};i._coroutine=j;return i},yield:function(){if(!shine.Coroutine._running){throw new shine.Error("attempt to yield across metamethod/C-call boundary (not in coroutine)")}if(shine.Coroutine._running.status!="running"){throw new shine.Error("attempt to yield non-running coroutine in host")}var m=shine.gc.createArray(),k=shine.Coroutine._running;for(var n=0,j=arguments.length;n<j;n++){m.push(arguments[n])}k._yieldVars=m;k.status="suspending";return{resume:function(){var p=[k],q,o=arguments.length,r=function(){shine.lib.coroutine.resume.apply(undefined,p)};for(q=0;q<o;q++){p.push(arguments[q])}if(k.status=="suspending"){window.setTimeout(r,1)}else{r()}}}}};shine.lib.debug={debug:function(){},getfenv:function(i){},gethook:function(i){},getinfo:function(i,j,k){},getlocal:function(i,k,j){},getmetatable:function(i){},getregistry:function(){},getupvalue:function(j,i){},setfenv:function(i,j){},sethook:function(i,l,j,k){},setlocal:function(i,l,j,k){},setmetatable:function(i,j){},setupvalue:function(j,i,k){},traceback:function(i,j,k){}};shine.lib.io={write:function(){var l,j,k="";for(var l in arguments){if(arguments.hasOwnProperty(l)){var j=arguments[l];if(["string","number"].indexOf(typeof j)==-1){throw new shine.Error("bad argument #"+l+" to 'write' (string expected, got "+typeof j+")")}k+=j}}shine.stdout.write(k)}};shine.lib.math={abs:function(i){return Math.abs(i)},acos:function(i){return Math.acos(i)},asin:function(i){return Math.asin(i)},atan:function(i){return Math.atan(i)},atan2:function(j,i){return Math.atan2(j,i)},ceil:function(i){return Math.ceil(i)},cos:function(i){return Math.cos(i)},cosh:function(i){},deg:function(i){return i*180/Math.PI},exp:function(i){return Math.exp(i)},floor:function(i){return Math.floor(i)},fmod:function(i,j){return i%j},frexp:function(i,j){},huge:Infinity,ldexp:function(i,j){return i*Math.pow(2,j)},log:function(j,k){var i=Math.log(j);if(k!==undefined){return i/Math.log(k)}return i},log10:function(i){return Math.log(i)/Math.log(10)},max:function(){var j=-Infinity,l=arguments.length,k;for(k=0;k<l;k++){if(arguments[k]>j){j=arguments[k]}}return j},min:function(){var k=Infinity,l=arguments.length,j;for(j=0;j<l;j++){if(arguments[j]<k){k=arguments[j]}}return k},modf:function(i){var k=Math.floor(i),j=i-k;return[k,j]},pi:Math.PI,pow:function(i,k){var j=shine.utils.coerce;i=j(i,"number","bad argument #1 to 'pow' (number expected)");k=j(k,"number","bad argument #2 to 'pow' (number expected)");return Math.pow(i,k)},rad:function(i){i=shine.utils.coerce(i,"number","bad argument #1 to 'rad' (number expected)");return(Math.PI/180)*i},random:function(j,i){if(j===undefined&&i===undefined){return c()}if(typeof j!=="number"){throw new shine.Error("bad argument #1 to 'random' (number expected)")}if(i===undefined){i=j;j=1}else{if(typeof i!=="number"){throw new shine.Error("bad argument #2 to 'random' (number expected)")}}if(j>i){throw new shine.Error("bad argument #2 to 'random' (interval is empty)")}return Math.floor(c()*(i-j+1)+j)},randomseed:function(i){if(typeof i!=="number"){throw new shine.Error("bad argument #1 to 'randomseed' (number expected)")}g=i},sin:function(i){return Math.sin(i)},sinh:function(i){},sqrt:function(i){return Math.sqrt(i)},tan:function(i){return Math.tan(i)},tanh:function(i){}};shine.lib.os={clock:function(){},date:function(s,n){if(s===undefined){s="%c"}var t=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],l=["January","February","March","April","May","June","July","August","September","October","November","December"],j=[31,28,31,30,31,30,31,31,30,31,30,31],q=function(x,i){var v=parseInt(o["%j"](x),10),u=new Date(x.getFullYear(),0,1,12),w=(8-u["get"+r+"Day"]()+i)%7;return("0"+(Math.floor((v-w)/7)+1)).substr(-2)},o={"%a":function(i){return t[i["get"+r+"Day"]()].substr(0,3)},"%A":function(i){return t[i["get"+r+"Day"]()]},"%b":function(i){return l[i["get"+r+"Month"]()].substr(0,3)},"%B":function(i){return l[i["get"+r+"Month"]()]},"%c":function(i){return i["to"+r+"LocaleString"]()},"%d":function(i){return("0"+i["get"+r+"Date"]()).substr(-2)},"%H":function(i){return("0"+i["get"+r+"Hours"]()).substr(-2)},"%I":function(i){return("0"+((i["get"+r+"Hours"]()+11)%12+1)).substr(-2)},"%j":function(x){var v=x["get"+r+"Date"](),u=x["get"+r+"Month"]();for(var w=0;w<u;w++){v+=j[w]}if(u>1&&x["get"+r+"FullYear"]()%4===0){v+=1}return("00"+v).substr(-3)},"%m":function(i){return("0"+(i["get"+r+"Month"]()+1)).substr(-2)},"%M":function(i){return("0"+i["get"+r+"Minutes"]()).substr(-2)},"%p":function(i){return(i["get"+r+"Hours"]()<12)?"AM":"PM"},"%S":function(i){return("0"+i["get"+r+"Seconds"]()).substr(-2)},"%U":function(i){return q(i,0)},"%w":function(i){return""+(i["get"+r+"Day"]())},"%W":function(i){return q(i,1)},"%x":function(i){return o["%m"](i)+"/"+o["%d"](i)+"/"+o["%y"](i)},"%X":function(i){return o["%H"](i)+":"+o["%M"](i)+":"+o["%S"](i)},"%y":function(i){return o["%Y"](i).substr(-2)},"%Y":function(i){return""+i["get"+r+"FullYear"]()},"%Z":function(i){return r?"UTC":i.toString().substr(-4,3)},"%%":function(){return"%"}},r="",m=new Date();if(n){m.setTime(n*1000)}if(s.substr(0,1)==="!"){s=s.substr(1);r="UTC"}if(s==="*t"){var k=function(v){var u=v.getFullYear(),i=new Date(u,0);return(v.getTimezoneOffset()!==i.getTimezoneOffset())};return new shine.Table({year:parseInt(o["%Y"](m),10),month:parseInt(o["%m"](m),10),day:parseInt(o["%d"](m),10),hour:parseInt(o["%H"](m),10),min:parseInt(o["%M"](m),10),sec:parseInt(o["%S"](m),10),wday:parseInt(o["%w"](m),10)+1,yday:parseInt(o["%j"](m),10),isdst:k(m)})}for(var p in o){if(o.hasOwnProperty(p)&&s.indexOf(p)>=0){s=s.replace(p,o[p](m))}}return s},difftime:function(i,j){return i-j},execute:function(){if(arguments.length){throw new shine.Error("shell is not available. You should always check first by calling os.execute with no parameters")}return 0},exit:function(){throw"Execution terminated."},getenv:function(){},remove:function(){},rename:function(){},setlocale:function(){},time:function(n){var p;if(!n){p=Date.now?Date.now():new Date().getTime()}else{var j,o,m,i,k,l;if(!(j=n.getMember("day"))){throw new shine.Error("Field 'day' missing in date table")}if(!(o=n.getMember("month"))){throw new shine.Error("Field 'month' missing in date table")}if(!(m=n.getMember("year"))){throw new shine.Error("Field 'year' missing in date table")}i=n.getMember("hour")||12;k=n.getMember("min")||0;l=n.getMember("sec")||0;if(n.getMember("isdst")){i--}p=new Date(m,o-1,j,i,k,l).getTime()}return Math.floor(p/1000)},tmpname:function(){}};shine.lib["package"]={cpath:undefined,loaded:new shine.Table(),loadlib:function(j,i){},path:"?.lua.json;?.json;./modules/?.json;./modules/?/?.json;./modules/?/index.json",preload:{},seeall:function(i){}};shine.lib.string={"byte":function(o,n,m){n=n||1;m=m||n;var k=shine.gc.createArray(),p=o.length,l;for(l=n;l<=p&&l<=m;l++){k.push(o.charCodeAt(l-1)||undefined)}return k},"char":function(){var j="";for(var m=0,k=arguments.length;m<k;m++){j+=String.fromCharCode(arguments[m])}return j},dump:function(i){return JSON.stringify(i._data)},find:function(n,o,p,l){if(typeof n!="string"&&typeof n!="number"){throw new shine.Error("bad argument #1 to 'find' (string expected, got "+typeof n+")")}if(typeof o!="string"&&typeof o!="number"){throw new shine.Error("bad argument #2 to 'find' (string expected, got "+typeof o+")")}n=""+n;p=p||1;var k,m,j,i;if(l===undefined||!l){o=h(o);m=new RegExp(o);k=n.substr(p-1).search(m);if(k<0){return}j=n.substr(p-1).match(m);i=[k+p,k+p+j[0].length-1];j.shift();return i.concat(j)}k=n.indexOf(o,p-1);return(k===-1)?undefined:[k+1,k+o.length]},format:function(j){var i={init:function(){if(typeof arguments=="undefined"){return null}if(arguments.length<1){return null}if(typeof arguments[0]!="string"){return null}if(typeof RegExp=="undefined"){return null}var s=arguments[0];var m=new RegExp(/(%([%]|(\-)?(\+|\x20)?(0)?(\d+)?(\.(\d)?)?([bcdfosxX])))/g);var q=new Array();var u=new Array();var k=0;var r=0;var w=0;var n=0;var t="";var p=null;while(p=m.exec(s)){if(p[9]){k+=1}r=n;w=m.lastIndex-p[0].length;u[u.length]=s.substring(r,w);n=m.lastIndex;q[q.length]={match:p[0],left:p[3]?true:false,sign:p[4]||"",pad:p[5]||" ",min:p[6]||0,precision:p[8],code:p[9]||"%",negative:parseInt(arguments[k])<0?true:false,argument:String(arguments[k])}}u[u.length]=s.substring(n);if(q.length==0){return s}if((arguments.length-1)<k){return null}var l=null,p=null,o=null,v;for(o=0;o<q.length;o++){if(q[o].code=="%"){v="%"}else{if(q[o].code=="b"){q[o].argument=String(Math.abs(parseInt(q[o].argument)).toString(2));v=i.convert(q[o],true)}else{if(q[o].code=="c"){q[o].argument=String(String.fromCharCode(Math.abs(parseInt(q[o].argument))));v=i.convert(q[o],true)}else{if(q[o].code=="d"){q[o].argument=String(Math.abs(parseInt(q[o].argument)));v=i.convert(q[o])}else{if(q[o].code=="f"){q[o].argument=String(Math.abs(parseFloat(q[o].argument)).toFixed(q[o].precision?q[o].precision:6));v=i.convert(q[o])}else{if(q[o].code=="o"){q[o].argument=String(Math.abs(parseInt(q[o].argument)).toString(8));v=i.convert(q[o])}else{if(q[o].code=="s"){q[o].argument=q[o].argument.substring(0,q[o].precision?q[o].precision:q[o].argument.length);v=i.convert(q[o],true)}else{if(q[o].code=="x"){q[o].argument=String(Math.abs(parseInt(q[o].argument)).toString(16));v=i.convert(q[o])}else{if(q[o].code=="X"){q[o].argument=String(Math.abs(parseInt(q[o].argument)).toString(16));v=i.convert(q[o]).toUpperCase()}else{v=q[o].match}}}}}}}}}t+=u[o];t+=v}t+=u[o];return t},convert:function(m,o){if(o){m.sign=""}else{m.sign=m.negative?"-":m.sign}var k=m.min-m.argument.length+1-m.sign.length;var n=new Array(k<0?0:k).join(m.pad);if(!m.left){if(m.pad=="0"||o){return m.sign+n+m.argument}else{return n+m.sign+m.argument}}else{if(m.pad=="0"||o){return m.sign+m.argument+n.replace(/0/g," ")}else{return m.sign+m.argument+n}}}};return i.init.apply(null,arguments)},gmatch:function(j,l){l=h(l);var i=new RegExp(l,"g"),k=(""+j).match(i);return function(){var n=k.shift(),m=new RegExp(i).exec(n);if(n===undefined){return}m.shift();return m.length?m:n}},gsub:function(r,p,m,i){if(typeof r!="string"&&typeof r!="number"){throw new shine.Error("bad argument #1 to 'gsub' (string expected, got "+typeof r+")")}if(typeof p!="string"&&typeof p!="number"){throw new shine.Error("bad argument #2 to 'gsub' (string expected, got "+typeof p+")")}if(i!==undefined&&(i=shine.utils.coerce(i,"number"))===undefined){throw new shine.Error("bad argument #4 to 'gsub' (number expected, got "+typeof i+")")}r=""+r;p=h(""+p);var o=0,t="",q,l,k,j;while((i===undefined||o<i)&&r&&(k=r.match(p))){if(typeof m=="function"||(m||shine.EMPTY_OBJ) instanceof shine.Function){q=m.apply(null,[k[0]],true);if(q instanceof Array){q=q[0]}if(q===undefined){q=k[0]}}else{if((m||shine.EMPTY_OBJ) instanceof shine.Table){q=m.getMember(k[0])}else{if(typeof m=="object"){q=m[k]}else{q=(""+m).replace(/%([0-9])/g,function(n,s){return k[s]})}}}if(k[0].length==0&&j===undefined){l=""}else{l=r.split(k[0],1)[0]}j=k[0];t+=l+q;r=r.substr((l+j).length);o++}return[t+r,o]},len:function(i){if(typeof i!="string"&&typeof i!="number"){throw new shine.Error("bad argument #1 to 'len' (string expected, got "+typeof i+")")}return(""+i).length},lower:function(i){if(typeof i!="string"&&typeof i!="number"){throw new shine.Error("bad argument #1 to 'lower' (string expected, got "+typeof i+")")}return(""+i).toLowerCase()},match:function(i,k,l){if(typeof i!="string"&&typeof i!="number"){throw new shine.Error("bad argument #1 to 'match' (string expected, got "+typeof i+")")}if(typeof k!="string"&&typeof k!="number"){throw new shine.Error("bad argument #2 to 'match' (string expected, got "+typeof k+")")}l=l?l-1:0;i=(""+i).substr(l);var j=i.match(new RegExp(h(k)));if(!j){return}if(!j[1]){return j[0]}j.shift();return j},rep:function(l,m){var j="",k;for(k=0;k<m;k++){j+=l}return j},reverse:function(l){var j="",k;for(k=l.length;k>=0;k--){j+=l.charAt(k)}return j},sub:function(m,l,k){if(typeof m!="string"&&typeof m!="number"){throw new shine.Error("bad argument #1 to 'sub' (string expected, got "+typeof m+")")}m=""+m;l=l||1;k=k||m.length;if(l>0){l=l-1}else{if(l<0){l=m.length+l}}if(k<0){k=m.length+k+1}return m.substring(l,k)},upper:function(i){return i.toUpperCase()}};shine.lib.table={concat:function(o,m,n,l){if(!((o||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in table.concat(). Table expected")}m=m||"";n=n||1;l=l||shine.lib.table.maxn(o);var k=shine.gc.createArray().concat(o.__shine.numValues).splice(n,l-n+1);return k.join(m)},getn:function(p){if(!((p||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in table.getn(). Table expected")}var q=p.__shine.numValues,o=shine.gc.createArray(),n,l=0;for(n in q){if(q.hasOwnProperty(n)){o[n]=true}}while(o[l+1]){l++}if(l>0&&q[l]===undefined){var n=0;while(l-n>1){var k=Math.floor((n+l)/2);if(q[k]===undefined){l=k}else{n=k}}return n}return l},insert:function(k,j,l){if(!((k||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in table.insert(). Table expected")}if(l==undefined){l=j;j=k.__shine.numValues.length}var i=k.getMember(j);k.setMember(j,l);if(i){shine.lib.table.insert(k,j+1,i)}},maxn:function(i){if(!((i||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in table.maxn(). Table expected")}return i.__shine.numValues.length-1},remove:function(l,k){if(!((l||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in table.remove(). Table expected")}var j=shine.lib.table.getn(l),m=l.__shine.numValues,i;if(k>j){return}if(k==undefined){k=j}i=m.splice(k,1);while(k<j&&m[k]===undefined){delete m[k++]}return i},sort:function(k,j){if(!((k||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 to 'sort' (table expected)")}var l,i=k.__shine.numValues;if(j){if(!((j||shine.EMPTY_OBJ) instanceof shine.Function)){throw new shine.Error("Bad argument #2 to 'sort' (function expected)")}l=function(n,m){return j.apply(null,[n,m],true)[0]?-1:1}}else{l=function(n,m){return n<m?-1:1}}i.shift();i.sort(l).unshift(undefined)},unpack:function(n,m,l){if(!((n||shine.EMPTY_OBJ) instanceof shine.Table)){throw new shine.Error("Bad argument #1 in unpack(). Table expected")}m=m||1;if(l===undefined){l=shine.lib.table.getn(n)}var o=shine.gc.createArray(),k;for(k=m;k<=l;k++){o.push(n.getMember(k))}return o}}})();var shine=shine||{};(function(){var a=/^[-+]?[0-9]*\.?([0-9]+([eE][-+]?[0-9]+)?)?$/;shine.utils={coerce:function(d,c,b){var f;switch(c){case"boolean":return !(d===false||d===undefined);case"string":switch(true){case d===undefined:return"nil";case d===Infinity:return"inf";case d===-Infinity:return"-inf";case typeof d=="number"&&window.isNaN(d):return"nan";default:return e.toString()}case"number":if(d===Infinity||d===-Infinity||(typeof d=="number"&&window.isNaN(d))){return d}if((""+d).match(a)){f=parseFloat(d)}if(f===undefined&&b){throw new shine.Error(b)}return f;default:throw new ReferenceError("Can not coerce to type: "+c)}},toObject:function(h){var g=shine.lib.table.getn(h)>0,b=shine.gc["create"+(g?"Array":"Object")](),d=h.__shine.numValues,f,c=d.length;for(f=1;f<c;f++){b[f-1]=((d[f]||shine.EMPTY_OBJ) instanceof shine.Table)?shine.utils.toObject(d[f]):d[f]}for(f in h){if(h.hasOwnProperty(f)&&!(f in shine.Table.prototype)&&f!=="__shine"){b[f]=((h[f]||shine.EMPTY_OBJ) instanceof shine.Table)?shine.utils.toObject(h[f]):h[f]}}return b},parseJSON:function(b){var c=function(f){for(var d in f){if(f.hasOwnProperty(d)){if(typeof f[d]==="object"){f[d]=c(f[d])}else{if(f[d]===null){f[d]=undefined}}}}return new shine.Table(f)};return c(JSON.parse(b))},get:function(c,f,b){var d=new XMLHttpRequest();d.open("GET",c,true);d.responseType="text";d.onload=function(g){if(this.status==200){if(f){f(this.response)}}else{if(b){b(this.status)}}};d.send(shine.EMPTY_OBJ)}}})();var shine=shine||{};shine.stdout={};shine.stdout.write=function(a){if(console&&console.log){console.log(a)}else{if(trace){trace(a)}}};shine.stddebug={};shine.stddebug.write=function(a){};shine.stderr={};shine.stderr.write=function(a,b){b=b||"error";if(console&&console[b]){console[b](a)}};if(typeof module!="undefined"){module.exports=shine};